#!/bin/bash
# tc - iTerm2 titlebar color and window control
# Usage: tc <color>              - color current window
#        tc list                 - show windows + ttys
#        tc list <target> <color> - color specific window
#        tc -t <target> <color>  - same as above
#          target: 1.2           - win.tab number
#                  012           - tty number (short)
#                  /dev/ttys012  - full tty path
#        tc title <text>         - set window title
#        tc focus <win.tab>      - bring window to front

# Build the escape sequence for RGB (0-255)
make_seq() {
  printf '\033]6;1;bg;red;brightness;%d\a\033]6;1;bg;green;brightness;%d\a\033]6;1;bg;blue;brightness;%d\a' "$1" "$2" "$3"
}

# Parse -t option for target tty
# Accepts: win.tab (1.2), tty number (012), or full path (/dev/ttys012)
TARGET=""
if [[ "$1" == "-t" ]]; then
  spec="$2"
  shift 2

  if [[ "$spec" =~ ^[0-9]+\.[0-9]+$ ]]; then
    # win.tab format - look up tty via AppleScript
    win="${spec%%.*}"
    tab="${spec##*.}"
    TARGET=$(osascript -e "
      tell application \"iTerm2\"
        set t to tab $tab of window $win
        set s to current session of t
        return tty of s
      end tell
    " 2>/dev/null)
    if [[ -z "$TARGET" ]]; then
      echo "Error: Cannot find window $spec" >&2
      exit 1
    fi
  elif [[ "$spec" =~ ^[0-9]+$ ]]; then
    # tty number - prepend /dev/ttys
    TARGET="/dev/ttys$spec"
  else
    # full path - use as-is
    TARGET="$spec"
  fi
fi

# Output to target (stdout or specific tty)
output_seq() {
  if [[ -n "$TARGET" ]]; then
    if [[ -w "$TARGET" ]]; then
      printf '%s' "$1" > "$TARGET"
    else
      echo "Error: Cannot write to $TARGET" >&2
      exit 1
    fi
  else
    printf '%s' "$1"
  fi
}

case "$1" in
  # Basic colors
  green|g)    output_seq "$(make_seq 0 180 0)" ;;
  red|r)      output_seq "$(make_seq 200 0 0)" ;;
  blue|b)     output_seq "$(make_seq 0 0 200)" ;;
  orange|o)   output_seq "$(make_seq 255 128 0)" ;;
  purple|p)   output_seq "$(make_seq 150 0 200)" ;;
  yellow|y)   output_seq "$(make_seq 200 200 0)" ;;
  cyan|c)     output_seq "$(make_seq 0 180 180)" ;;
  pink)       output_seq "$(make_seq 255 100 150)" ;;

  # Softer/muted colors (from termcolor)
  amber)      output_seq "$(make_seq 255 204 127)" ;;
  peach)      output_seq "$(make_seq 255 204 178)" ;;
  lavender)   output_seq "$(make_seq 204 178 230)" ;;
  sage)       output_seq "$(make_seq 204 230 191)" ;;
  cream)      output_seq "$(make_seq 255 245 215)" ;;
  slate)      output_seq "$(make_seq 102 115 128)" ;;
  charcoal)   output_seq "$(make_seq 51 60 68)" ;;
  coal)       output_seq "$(make_seq 30 30 35)" ;;
  black|noir) output_seq "$(make_seq 0 0 0)" ;;
  poo)        output_seq "$(make_seq 139 90 43)" ;;
  teal)       output_seq "$(make_seq 153 215 230)" ;;
  mustard)    output_seq "$(make_seq 227 184 10)" ;;
  gold)       output_seq "$(make_seq 255 215 0)" ;;

  # School colors
  princeton)  output_seq "$(make_seq 255 103 31)" ;;
  forrest)    output_seq "$(make_seq 34 139 34)" ;;
  columbia)   output_seq "$(make_seq 185 217 235)" ;;
  nyu)        output_seq "$(make_seq 87 6 140)" ;;
  texas|ut|utexas)  output_seq "$(make_seq 191 87 0)" ;;  # Burnt Orange
  caltech|cit)  output_seq "$(make_seq 198 146 20)" ;;  # mustard gold
  mit)  output_seq "$(make_seq 163 31 52)" ;;  # MIT Cardinal Red
  stanford)  output_seq "$(make_seq 140 21 21)" ;;  # Stanford Cardinal
  harvard)  output_seq "$(make_seq 165 28 48)" ;;  # Harvard Crimson
  berkeley|cal)  output_seq "$(make_seq 253 181 21)" ;;  # California Gold
  yale)  output_seq "$(make_seq 0 53 107)" ;;  # Yale Blue
  penn)  output_seq "$(make_seq 1 31 91)" ;;  # Penn Blue
  cornell)  output_seq "$(make_seq 179 27 27)" ;;  # Carnelian
  brown)  output_seq "$(make_seq 78 54 41)" ;;  # Brown University
  dartmouth)  output_seq "$(make_seq 0 105 62)" ;;  # Dartmouth Green
  duke)  output_seq "$(make_seq 0 48 135)" ;;  # Duke Blue
  edi)  output_seq "$(make_seq 185 14 47  )" ;;  # Edinburgh Blue #B90E2F ( make_seq 185 14 47 )

  # Other
  money)      output_seq "$(make_seq 85 130 50)" ;;  # dollar bill green
  brat)  output_seq "$(make_seq 138 206 0)" ;;  # brat green

  reset|x|0)  output_seq "$(printf '\033]6;1;bg;*;default\a')" ;;

  set)
    # tc set puke 142 58 203
    if [[ -z "$2" || -z "$3" || -z "$4" || -z "$5" ]]; then
      echo "Usage: tc set <name> <r> <g> <b>" >&2
      exit 1
    fi
    name="$2" r="$3" g="$4" b="$5"
    cf=~/.tc-colors
    # Remove existing entry for this name, then append
    if [[ -f "$cf" ]]; then
      grep -v "^${name} " "$cf" > "$cf.tmp" && mv "$cf.tmp" "$cf"
    fi
    echo "$name $r $g $b" >> "$cf"
    output_seq "$(make_seq "$r" "$g" "$b")"
    echo "Saved: tc $name -> rgb $r $g $b" >&2
    ;;

  random|rand)
    _r=$((RANDOM % 256)) _g=$((RANDOM % 256)) _b=$((RANDOM % 256))
    output_seq "$(make_seq $_r $_g $_b)"
    echo "rgb $_r $_g $_b" >&2
    ;;

  rgb)
    # tc rgb 255 128 0
    if [[ -n "$2" && -n "$3" && -n "$4" ]]; then
      output_seq "$(make_seq "$2" "$3" "$4")"
    else
      echo "Usage: tc rgb <r> <g> <b>  (0-255)" >&2
    fi
    ;;

  list|ls)
    # If given target + color args, act like -t (e.g., tc list 1.1 harvard)
    if [[ -n "$2" && -n "$3" ]]; then
      spec="$2"
      color="$3"
      if [[ "$spec" =~ ^[0-9]+\.[0-9]+$ ]]; then
        win="${spec%%.*}"
        tab="${spec##*.}"
        TARGET=$(osascript -e "
          tell application \"iTerm2\"
            set t to tab $tab of window $win
            set s to current session of t
            return tty of s
          end tell
        " 2>/dev/null)
        if [[ -z "$TARGET" ]]; then
          echo "Error: Cannot find window $spec" >&2
          exit 1
        fi
      elif [[ "$spec" =~ ^[0-9]+$ ]]; then
        TARGET="/dev/ttys$spec"
      else
        TARGET="$spec"
      fi
      # Re-invoke with the color (shift to make $color become $1 for case)
      shift 2
      exec "$0" ${TARGET:+-t "$TARGET"} "$@"
    fi
    # No args - show window list
    echo "iTerm2 windows:"
    echo "---------------"
    osascript -e '
    tell application "iTerm2"
      set output to ""
      set winIdx to 1
      repeat with w in windows
        set tabIdx to 1
        repeat with t in tabs of w
          set s to current session of t
          set ttyPath to tty of s
          set sessName to name of s
          set output to output & "  " & winIdx & "." & tabIdx & "  " & ttyPath & "  " & sessName & linefeed
          set tabIdx to tabIdx + 1
        end repeat
        set winIdx to winIdx + 1
      end repeat
      return output
    end tell
    ' 2>/dev/null
    echo ""
    echo "Usage: tc list <win.tab> <color>  or  tc -t <target> <color>"
    ;;

  title)
    shift
    if [[ -z "$*" ]]; then
      echo "Usage: tc title <text>" >&2
      exit 1
    fi
    # Set title using escape sequence
    printf '\033]0;%s\007' "$*"
    ;;

  focus)
    # tc focus 2.1 - bring window 2 tab 1 to front
    if [[ -z "$2" ]]; then
      echo "Usage: tc focus <win.tab>  (e.g., tc focus 2.1)" >&2
      exit 1
    fi
    win="${2%%.*}"
    osascript -e "tell application \"iTerm2\"" \
              -e "activate" \
              -e "set index of window $win to 1" \
              -e "end tell" 2>/dev/null
    ;;

  help|-h|--help|"")
    cat <<'EOF'
tc - iTerm2 titlebar color and window control

Usage: tc <color>                 # current window
       tc list                    # show windows + ttys
       tc list 1.1 <color>        # color by win.tab number
       tc -t 1.1 <color>          # same as above
       tc -t 012 <color>          # by tty number
       tc -t /dev/ttys012 <color> # by full path
       tc title <text>            # set window title
       tc focus <win.tab>         # bring window to front
       tc rgb <r> <g> <b>         # custom RGB (0-255)
       tc set <name> <r> <g> <b>     # save a custom color

Colors:
  Basic:  green/g red/r blue/b orange/o purple/p yellow/y cyan/c pink
  Soft:   amber peach lavender sage cream slate charcoal coal black/noir poo teal mustard gold
  School: princeton forrest columbia nyu texas/ut caltech/cit mit stanford harvard berkeley/cal yale penn cornell brown dartmouth duke
  Other:  random reset/x brat money
  Custom: saved via 'tc set' (~/.tc-colors)

Examples:
  tc green              # color this window green
  tc list               # see all windows
  tc list 1.2 blue      # color window 1 tab 2
  tc list 003 orange    # color tty 003
  tc title myproject    # set title
  tc sage               # nice muted green
EOF
    ;;

  *)
    # Check user-saved colors
    cf=~/.tc-colors
    if [[ -f "$cf" ]]; then
      read -r _n _r _g _b <<< "$(grep "^$1 " "$cf")"
      if [[ -n "$_r" ]]; then
        output_seq "$(make_seq "$_r" "$_g" "$_b")"
        exit 0
      fi
    fi
    echo "Unknown: $1 (try 'tc help')" >&2
    exit 1
    ;;
esac
