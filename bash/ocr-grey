#!/bin/bash

# Check if --help option is provided
if [ "$1" == "--help" ]; then
    tesseract --list-langs
    exit 0
fi

# Check if at least one argument is provided
if [ $# -lt 1 ]; then
    echo "Usage: ocr input_file [options]"
    echo "e.g., ocr foo.png -l fra --oem 1"
    exit 1
fi

input_file=$1
shift  # This will remove the first argument, and shift all the others to the left

options=""
if [ $# -eq 0 ]; then
    options="-l eng --oem 1"
else
    options=$*
fi

# Check if the input file exists
if [ ! -f "$input_file" ]; then
    echo "Input file does not exist: $input_file"
    exit 1
fi

# Define output file and directory
base_filename=$(basename -- "$input_file")
base_filename_no_ext="${base_filename%.*}"
output_dir="$base_filename_no_ext"
mkdir -p "$output_dir"
output_file="$output_dir/$base_filename_no_ext.ocr"

echo "STARTING ocr on $input_file at $(date) ..."

# Convert PDF to Images
pdftoppm -png "$input_file" "$output_dir/page"

# OCR on the images
for img in $(ls "$output_dir"/*.png); do
    tesseract $img $output_dir/$(basename $img .png) $options
done

# Combine all OCR'd text into one file
cat "$output_dir"/*.txt > "$output_file"

echo "OCR complete."
