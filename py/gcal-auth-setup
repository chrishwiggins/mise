#!/usr/bin/env python3
"""
Setup and test Google Calendar API credentials.
Uses google_auth.py for credential resolution and token caching.

Credentials: ~/.config/gcal/credentials.json
Tokens:      ~/.config/google-tokens/calendar.pickle
"""

import sys
from google_auth import get_credentials
from googleapiclient.discovery import build


def setup_and_test():
    """Authenticate (if needed) and test the Calendar API."""
    print("Google Calendar API Setup")
    print("=" * 40)
    print()
    print("Credentials: ~/.config/gcal/credentials.json")
    print("Tokens:      ~/.config/google-tokens/calendar.pickle")
    print()

    try:
        creds = get_credentials(service="calendar", scopes="calendar")
    except FileNotFoundError as e:
        print(f"Error: {e}")
        print()
        print("To fix:")
        print("1. Go to console.cloud.google.com > Google Auth Platform > Clients")
        print("2. Download OAuth credentials JSON")
        print("3. Save as ~/.config/gcal/credentials.json")
        print()
        print("See ~/.config/gdrive/GOTCHA.md for detailed steps.")
        return False

    service = build("calendar", "v3", credentials=creds)

    try:
        result = service.calendarList().list().execute()
        calendars = result.get("items", [])
        print(f"API working. Found {len(calendars)} calendars:")
        for cal in calendars[:5]:
            print(f"  - {cal['summary']}")
        return True
    except Exception as e:
        print(f"API test failed: {e}")
        return False


if __name__ == "__main__":
    sys.exit(0 if setup_and_test() else 1)
